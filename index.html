<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="app">
    <h1>123123123123</h1>
    <h2>{{title}}</h2>
    <h1>{{name}}</h1>
  </div>
  <script>
    /**
     * @name: Dep 
     * @test: test font
     * @msg: 订阅器
     * @param {type} 
     * @return {type} 
     */
    // 创建dep对象，声明对象中订阅者list属性
    function Dep() {
      this.subs = []
    }
    // 给dep对象声明方法： 添加订阅者方法、修改
    Dep.prototype = {
      addSub: function (sub) {
        this.subs.push(sub)
      },
      notify: function () {
        this.subs.forEach((sub) => {
          sub.update()
        })
      }
    }
    /**
     * @name: watcher
     * @test: test font
     * @msg: 监听器
     * @param {type} 
     * @return {type} 
     */
    function Watcher(vm, exp, cb) {
      this.cb = cb;
      this.vm = vm;
      this.exp = exp;
      this.value = this.get(); // 将自己添加到订阅器中
    }
    // 
    Watcher.prototype = {
      update: function () {
        this.run()
      },
      run: function () {
        var value = this.vm.data[this.exp];
        var oldVal = this.value
        if (value !== oldVal) {
          this.cb.call(this.vm, value, oldVal);
        }
      },
      get: function () {
        Dep.target = this; // 缓存自己
        var value = this.vm.data[this.exp] // 强制执行监听器里的get函数
        Dep.target = null; // 释放自己
        return value
      }
    }
    /**
     * @name: Observer 
     * @test: test font
     * @msg: 劫持监听所有属性
     * @param {type} 
     * @return {type} 
     */
    // console.log(book.name);
    function defineReactive(data, key, val) {
      // 递归调用，去判断当前data是否是对象
      observe(val)
      var dep = new Dep();
      // 注册对象属性
      Object.defineProperty(data, key, {
        configurable: true,
        enumerable: true,
        get: () => {
          // if (是否需要添加订阅者) {
          //   dep.addSub(watcher); // 在这里添加一个订阅者
          // }
          if (Dep.target) {  // 判断是否需要添加订阅者
            dep.addSub(Dep.target); // 在这里添加一个订阅者
          }
          console.log('get:属性' + key + '已经被监听了，得到：“' + JSON.stringify(val) + '”');
          return val
        },
        set: (newVal) => {
          // 判断值是否修改
          if (val === newVal) {
            return;
          }
          console.log('set:属性' + key + '已经被监听了，现在值为：“' + newVal.toString() + '”');
          val = newVal;
          // 如果数据修改 通知dep订阅者
          dep.notify();
        }
      })
    }
    function observe(data) {
      // 判断传入的data是否有效！data需：object
      // debugger
      if (!data || typeof data !== 'object') {
        return;
      }
      console.log('!', data)
      // 遍历对象 将data对象的key遍历出来
      Object.keys(data).forEach(key => {
        // debugger
        // 调用注册属性方法，传入当前对象、当前遍历的key，data[key]下属性
        defineReactive(data, key, data[key])
      })
    }
    /**
     * @name: Compile
     * @test: test font
     * @msg: 解析器：编译解析dom
     * @param {type} 
     * @return {type} 
     */
    function Compile(el, vm) {
      this.vm = vm;
      // debugger
      this.el = document.querySelector(el);
      this.fragment = null;
      this.init();
    }
    Compile.prototype = {
      init: function () {
        if (this.el) {
          this.fragment = this.nodeToFragment(this.el);
          this.compileElement(this.fragment);
          this.el.appendChild(this.fragment);
        } else {
          console.log('Dom元素不存在');
        }
      },
      nodeToFragment: function (el) {
        var fragment = document.createDocumentFragment();
        var child = el.firstChild;
        while (child) {
          // 将Dom元素移入fragment中
          fragment.appendChild(child);
          child = el.firstChild
        }
        return fragment;
      },
      compileElement: function (el) {
        var childNodes = el.childNodes;
        var self = this;
        [].slice.call(childNodes).forEach(function (node) {
          var reg = /\{\{\s*(.*?)\s*\}\}/;
          var text = node.textContent;
          if (self.isTextNode(node) && reg.test(text)) {  // 判断是否是符合这种形式{{}}的指令
            self.compileText(node, reg.exec(text)[1]);
          }

          if (node.childNodes && node.childNodes.length) {
            self.compileElement(node);  // 继续递归遍历子节点
          }
        });
      },
      compileText: function (node, exp) {
        var self = this;
        var initText = this.vm[exp];
        this.updateText(node, initText);  // 将初始化的数据初始化到视图中
        new Watcher(this.vm, exp, function (value) { // 生成订阅器并绑定更新函数
          self.updateText(node, value);
        });
      },
      updateText: function (node, value) {
        node.textContent = typeof value == 'undefined' ? '' : value;
      },
      isTextNode: function (node) {
        return node.nodeType == 3;
      }
    }

    /** SelfVue
     * @name:
     * @test: test font
     * @msg: 将监听和订阅链接起来
     * @param {type}
     * @return {type}
     */
    function SelfVue(options) {
      // debugger
      var self = this
      this.vm = this
      this.data = options.data;

      // 做伪代理，调用proxyKeys函数监听属性变化。通过：Object.defineProperty
      Object.keys(this.data).forEach((key) => {
        self.proxyKeys(key)
      })
      observe(this.data);
      new Compile(options.el, this.vm);
      // 1.模拟监听
      // observe(data);
      // el.innerHTML = this.data[exp]; // 初始化模版数据的值
      // new Watcher(this, exp, function (value) {
      //   el.innerHTML = value;
      // })
      return this;
    }
    SelfVue.prototype = {
      proxyKeys: function (key) {
        var self = this
        // debugger
        Object.defineProperty(this, key, {
          enumerable: false,
          configurable: true,
          get: () => {
            return self.data[key]
          },
          set: (newVal) => {
            self.data[key] = newVal
          }
        })
      }
    }

    var selfVue = new SelfVue({
      el: '#app',
      data: {
        title: 'hello world',
        name: ''
      }
    });

    window.setTimeout(function () {
      selfVue.title = '你好';
    }, 2000);

    window.setTimeout(function () {
      selfVue.name = 'canfoo';
    }, 2500);
  </script>
</body>

</html>